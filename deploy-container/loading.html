<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Server Loading</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #1e1e1e;
        color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        flex-direction: column;
      }
      .loader {
        border: 16px solid #3e3e3e;
        border-radius: 50%;
        border-top: 16px solid #0078d4;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        margin-bottom: 30px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .status {
        margin-top: 20px;
        font-size: 18px;
        text-align: center;
        max-width: 80%;
      }
      .log {
        margin-top: 30px;
        padding: 15px;
        background-color: #2d2d2d;
        border-radius: 5px;
        width: 80%;
        max-width: 600px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-line;
      }
      .refresh {
        margin-top: 20px;
        padding: 10px 15px;
        background-color: #0078d4;
        border: none;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="loader"></div>
    <h1>Code Server is Initializing</h1>
    <div class="status">
      Please wait while your environment is being prepared. This may take a few
      minutes.
    </div>
    <div class="log" id="log">Loading status...</div>
    <button class="refresh" onclick="window.location.reload()">
      Refresh Status
    </button>
    <script>
      // Function to scroll log to bottom
      function scrollToBottom() {
        const logElement = document.getElementById("log")
        logElement.scrollTop = logElement.scrollHeight
      }

      // Function to check if code-server is ready by looking for its login page or UI
      function checkCodeServerReady() {
        fetch("/", {
          method: "HEAD",
          cache: "no-store",
        })
          .then((response) => {
            // Check if response might be from code-server rather than loading server
            // The loading server only serves specific paths, so any success on "/"
            // means code-server is likely running
            if (response.ok && response.status === 200) {
              console.log("Code server may be ready, checking content type...")
              return response.headers.get("content-type")
            }
            return null
          })
          .then((contentType) => {
            if (contentType && contentType.includes("text/html")) {
              // Find out if it's from our loading page or from code-server
              return fetch("/loading-status.txt", { cache: "no-store" })
                .then((statusResponse) => {
                  if (statusResponse.status === 404) {
                    // If loading-status.txt is not found, code-server is running
                    console.log("Code-server is ready, redirecting...")
                    window.location.href = "/"
                    return true
                  }
                  return false
                })
                .catch(() => {
                  // If we can't fetch loading-status.txt, code-server might be running
                  console.log(
                    "Cannot fetch status, code-server might be ready, redirecting..."
                  )
                  window.location.href = "/"
                  return true
                })
            }
            return false
          })
          .catch((error) => {
            console.log("Error checking code-server status:", error)
            return false
          })
      }

      // Check for code-server every 3 seconds
      const readyCheckInterval = setInterval(checkCodeServerReady, 3000)

      // Auto-refresh the loading page every 10 seconds if code-server isn't ready yet
      const refreshTimeout = setTimeout(function () {
        window.location.reload()
      }, 10000)

      // Fetch the latest logs
      fetch("/loading-status.txt")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("log").innerText = data
          // Scroll to bottom after updating content
          scrollToBottom()

          // If logs contain a message about starting code-server, check more frequently
          if (data.includes("Starting code-server")) {
            console.log("Code-server is starting, checking more frequently...")
            // Clear existing interval and check more frequently
            clearInterval(readyCheckInterval)
            setInterval(checkCodeServerReady, 1000)
          }
        })
        .catch((err) => {
          document.getElementById("log").innerText =
            "Error loading status. Please try refreshing."
        })

      // Also scroll to bottom on initial load
      window.onload = scrollToBottom
    </script>
  </body>
</html>
